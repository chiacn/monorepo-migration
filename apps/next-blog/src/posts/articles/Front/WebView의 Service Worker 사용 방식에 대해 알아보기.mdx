---
title: WebView(하이브리드)의 Service Worker 사용 방식에 대해 알아보기
date: 2024-03-20
thumbnail: default.png
---

## WebView(하이브리드)의 Service Worker 사용 방식에 대해 알아보기

### 상황

회사에서 Webview를 기반으로한 앱(하이브리드)의 운영 이슈가 나와서 살펴보던 중 <br/>
그 원인이 Service Worker의 캐싱 때문인 것을 알게 됐다. <br/>
WebView 같은 경우 기존 앱에 이미 구축이 되어 있었지만 이번에 WebView에서 Service worker가 동작하는 원리를 살펴보면서 정리하기 위해 글을 쓴다.

### 기본 정의

> #### Service Worker?
>
> - 우선 Service worker는 주로 PWA에서 사용한다. <br/> (최신 웹뷰 스펙에서은 대부분 서비스워커를 지원한다. \*ios는 제한적 지원)
> - 주로 데이터 로딩을 **앱에서처럼 자연스럽게** 할 수 있도록 **오프라인** 지원 및 캐싱 기능을 지원한다.
> - 푸시 알림이나 데이터 동기화 같은 백그라운드에서 실행되는 작업을 처리할 수 있다. (네트워크가 복구되었을 때 데이터를 동기화할 수 있다.)
> - Proxy 역할 : 브라우저와 네트워크 사이에서 proxy처럼 동작해 요청을 가로채고 캐시를 사용하거나 네트워크에 요청을 보낼 수 있다.

### 왜 이 앱에서는 Service worker를 썼나.

우선 하이브리드앱에서는 굳이 Service worker가 필요한게 아니다. <br/>
그 이유로, 서비스워커가 제공하는 기능들은 대체로 네이티브 API에서 수행할 수 있기 때문이다. <br/>
(Service worker는 주로 웹 애플리케이션이 브라우저 내에서 Native App과 비슷한 **사용자 경험**을 제공하게 하기 위해 설계된 것임)

**그럼에도 불구하고,** 하이브리드 앱에서 Service worker를 사용함으로써 얻을 수 있는 이점은 아래와 같을 것이다.

1. 웹 기술 기반으로 웹개발자 친화성
2. 네트워크 요청을 가로채고 필요한 리소스를 캐싱하여 오프라인 상태에서도 앱의 일부 기능을 제공할 수 있다.
3. 유연한 캐싱 전략 (Cache First, Network First 등)
4. 브라우저에서 제공하는 표준화된 API 및 인터페이스를 사용하므로 정제된 기능을 복잡한 구현 없이 사용할 수 있다.
   (네이티브 API도 Service worker에서 제공하는 기능을 사용할 수 있지만 구현이 복잡해질 수 있음.)

### 실제 업무에서의한계

### 1. iOS ATS 정책과 관련된 한계

#### 용어 정리)

> #### ATS (App Transport Security) -
>
> 애플리케이션과 웹 서비스 사이에 통신에서 보안 향상을 위해 iOS 9.0부터 도입된 보안 정책으로 <br/>
> 보안이 취약한 네트워크를 차단하고 모든 인터넷 통신 시 안전한 프로토콜을 사용하는 것을 보장한다.
>
> - **HTTP 요청**은 차단되고 네트워크 요청이 **HTTPS**를 통해 안전하게 전송되도록 요구한다.
> - 특정 도메인에 대해 예외를 설정하려면 Info.plist 파일에 해당 도메인에 대한 허용 정책을 명시적으로 추가해야한다.

> #### App Bound Domain -
>
> iOS의 WKWebView에서 Service Worker를 사용하려면 Apple이 추가로 요구하는 App Bound Domains 규칙을 따라야 한다.
>
> - App Bound Domains는 앱이 사용할 도메인을 **명확히 정의**하는 개념이다.
> - WKWebView 내에서 Service Worker와 같은 고급 웹 기능 (ex. IndexedDB, WebRTC)을 사용하려면 앱의 Info.plist 파일에 해당 도메인들을 ** App Bound Domains 리스트**로 등록해야 한다. (**네이티브 단의 역할**)

---

-> App Bound Domains 리스트가 **10개를 초과**하거나 동적으로 호출되는 외부 도메인(예측 불가능한 도메인)이 있는 경우 iOS에서 Service worker를 사용하는데 제약이 있다.

---

### 2. 캐싱 전략에서의 문제점

#### 용어 정리)

> #### 캐시 SWAP 과정
>
> 새로운 리소스가 배포될 때 기존 캐시와 새로운 캐시를 교체(swap)하는 과정이다.

1.  **Service Worker 업데이트 시점** <br/>
    새로운 버전의 Service Worker가 배포되면 install 이벤트가 발생하여 새로운 리소스를 다운로드하고 캐시에 저장한다. <br/> (이 때 기존 리소스는 아직 active 상태의 이전 Service Worker가 관리하고 있다.)

2.  **캐시 SWAP 타이밍** <br/>
    새로운 Service Worker가 활성화(active 이벤트)되면, 이전 캐시를 삭제하고 새 캐시로 교체한다.

3.  **캐싱 SWAP의 지연** <br/>
    Service Worker는 백그라운드에서 작동하므로 캐시 SWAP은 네트워크 상태와 디바이스 성능에 따라 몇 초 이상 걸릴 수 있다.
    이 지연 동안 사용자가 앱을 사용하는 경우 old 캐시와 new 캐시가 혼합되어 처리될 수 있다.

---

-> Service Worker에서 **cache-first** 전략을 사용하고 있는 경우 Service Worker의 캐싱 **SWAP**이 완료되는 시점 전후로 요청되는 리소스에 대해
old 캐시와 new 캐시가 혼합되어 서빙될 수 있는 구조적인 문제 발생 (계속되는 서비스 증가로 인해 swap 완료 시점이 늘어남)

---

<br />
<br />
<br />
